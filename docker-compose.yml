version: '3.8'

services:
  # -----------------------------
  # üß† The Load Balancer
  # -----------------------------
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - ticket-app-1
      - ticket-app-2
      - ticket-app-3
    networks:
      - ticket-net

  # -----------------------------
  # üß± The 3 Go Replicas
  # -----------------------------
  ticket-app-1: &app-base
    build: .
    environment:
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=db
      # ‚ö†Ô∏è CRITICAL FIX: Always use 5432 inside Docker. 
      # Your .env has 5433 (for Windows), but inside Docker network it is standard 5432.
      - DB_PORT=5432  
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MY_JWT_KEY=${MY_JWT_KEY}
      - INSTANCE_ID=replica-1
    depends_on:
      db:
        condition: service_healthy # ‚è≥ Wait for PG "Ready to accept connections"
      redis:
        condition: service_healthy # ‚è≥ Wait for Redis PONG
    networks:
      - ticket-net

  ticket-app-2:
    <<: *app-base
    environment:
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=db
      - DB_PORT=5432
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MY_JWT_KEY=${MY_JWT_KEY}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ticket-net

  ticket-app-3:
    <<: *app-base
    environment:
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=db
      - DB_PORT=5432
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MY_JWT_KEY=${MY_JWT_KEY}
      - INSTANCE_ID=replica-3
    depends_on:
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ticket-net

  # -----------------------------
  # üíæ The Storage Layer
  # -----------------------------
  db:
    image: postgres:15-alpine
    command: postgres -c 'max_connections=500' 
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "${DB_PORT}:5432" 
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ticket-net

  redis:
    image: redis:alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6380:6379"
    # ‚úÖ HEALTH CHECK ADDED
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ticket-net
  migrate:
    image: migrate/migrate
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=db
      - DB_PORT=5432
    volumes:
      - ./internals/db/migrations:/migrations
    entrypoint: [ "sh", "-c" ]
    command:
      - migrate -path /migrations -database "postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=disable" up
    networks:
      - ticket-net

networks:
  ticket-net:
    driver: bridge